# Claude Agent Instructions for Voight

This file provides custom instructions for AI agents (Claude) working on the Voight VSCode extension project.

---

## On Session Start - MANDATORY READING

**Before doing anything else**, read these files in this exact order:

1. **`.ai/PROJECT_STATUS.md`** - Current implementation status, what's done, what's TODO
2. **`.ai/AGENT_CONTEXT.md`** - Design patterns, conventions, and decision rationale
3. **`ARCHITECTURE.md`** (if working on extension architecture)
4. **`src/detection/complexity/ARCHITECTURE.md`** (if working on complexity analysis)

**Do NOT start coding without reading these files.** They contain critical context about:
- What's already implemented (avoid duplicate work)
- Design philosophy (avoid violating core principles)
- Code patterns (maintain consistency)
- Common mistakes (avoid known pitfalls)

---

## Project Philosophy - NEVER VIOLATE

Voight is built on these principles. **Every feature must align with these**:

1. **Assume Competence**: Users are capable engineers. No forced workflows, quizzes, or tests.
2. **Never Block Flow**: Every action is optional. No modal dialogs that interrupt coding.
3. **Map to Real Cognitive Actions**: Features match how developers already think.
4. **No Bureaucracy**: No required states, mandatory categorization, or imposed process.
5. **Operate on Attention and Knowledge**: Help users understand and decide, don't decide for them.

**When in doubt**: Trust the user's judgment. Provide information, not enforcement.

---

## Current State (Quick Reference)

**Completion**: ~70% of V1
**Status**: Core detection and complexity analysis complete, 3/5 segment actions done

**What's Working**:
- ‚úÖ Paste detection with heuristics
- ‚úÖ Cyclomatic complexity analysis (Lizard port)
- ‚úÖ Function-level complexity scoring
- ‚úÖ Visual highlighting with state management
- ‚úÖ Webview UI with filtering
- ‚úÖ Dismiss action (fully working)
- ‚úÖ Flag/Note backend (needs UI wiring)

**What's Missing**:
- ‚ùå Trace action (show dependencies) - 0% complete
- ‚ùå Explain action (AI analysis) - 10% complete (stub only)
- ‚ùå Flag/Note UI (backend done, needs frontend)

**Next Priority**: Wire up Flag and Note UI, then implement Trace and Explain

See `.ai/PROJECT_STATUS.md` for detailed breakdown.

---

## Code Review Checklist

Before submitting any code, verify:

- [ ] **Philosophy**: Does it assume competence? Not block flow?
- [ ] **Patterns**: Follows existing patterns in similar files?
- [ ] **State**: State transitions are user-driven only (no forced workflows)?
- [ ] **Privacy**: Only minimal data sent to external services?
- [ ] **Testing**: Can be manually tested in <60 seconds?
- [ ] **Documentation**: Updated PROJECT_STATUS.md if status changed?
- [ ] **Vocabulary**: Uses consistent terminology (see AGENT_CONTEXT.md)?

---

## Common Patterns (Use These)

### Adding a New Segment Action

1. Create `src/ui/plugins/{action}Plugin.ts` implementing `BlockActionPlugin`
2. Register in `src/extension.ts`
3. Add UI button in `webview-ui/src/components/SegmentsList.ts`
4. Handle message in `src/ui/blockDetailPanel.v2.ts`

### Message Passing (Extension ‚Üî Webview)

```typescript
// Extension to Webview
panel.webview.postMessage({ type: 'actionName', data: {...} });

// Webview to Extension
vscode.postMessage({ type: 'actionName', data: {...} });
```

### Storage

```typescript
// Persistent data
context.workspaceState.update(key, value);

// Secrets (API keys)
context.secrets.store(key, value);
```

See `.ai/AGENT_CONTEXT.md` for complete pattern reference.

---

## Anti-Patterns (DON'T Do This)

‚ùå **Don't add forced workflows**:
```typescript
// BAD: Requiring state before action
if (block.state !== BlockState.REVIEWED) {
    throw new Error('Must review first');
}
```

‚ùå **Don't block the user**:
```typescript
// BAD: Confirmation dialogs on dismiss
const confirm = await showWarningMessage('Are you sure?');
```

‚ùå **Don't send full files to AI**:
```typescript
// BAD: Sending entire document
await ai.analyze(document.getText());

// GOOD: Only selected segment
await ai.analyze(segmentCode);
```

‚ùå **Don't store secrets in settings**:
```typescript
// BAD: API key in settings.json
config.get('apiKey');

// GOOD: API key in secrets storage
context.secrets.get('voight.apiKey');
```

---

## Architecture Quick Reference

**Detection Flow**:
```
User pastes ‚Üí PasteDetector (heuristics) ‚Üí ChangeDetector (diff)
‚Üí ComplexityAnalyzer (CCN scoring) ‚Üí BlockManager (UI registration)
```

**State Machine**:
```
DETECTED ‚Üí (user action) ‚Üí REVIEWED | FLAGGED | ACCEPTED | DISMISSED
```

**Plugin System**:
```typescript
interface BlockActionPlugin {
    name: string;
    canHandle(block): boolean;
    execute(block): Promise<void>;
}
```

---

## Language Support (Complexity Analysis)

**Currently Supported**: Go, TypeScript/JavaScript, Python

**To Add New Language**:
1. Create `src/detection/complexity/{lang}StateMachine.ts` (~150-300 lines)
2. Extend `StateMachine` base class
3. Implement `buildConditions()` and `stateGlobal()`
4. Register in `analyzer.ts`

**See**: `src/detection/complexity/ARCHITECTURE.md` for step-by-step guide

---

## Testing

**Manual Testing**:
1. Press F5 to launch Extension Development Host
2. Open a `.ts`/`.go`/`.py` file
3. Paste a multi-line function (>50 chars)
4. Verify highlighting and complexity score

**Integration Tests**:
```bash
npx ts-node src/detection/complexity/__tests__/test-phase2.ts
```

**Debug Mode**:
```json
// settings.json
{ "voight.debug.enabled": true }
```
Check Output panel ‚Üí "Voight Debug"

---

## Session Handoff Protocol

**Before ending session**, update:

1. `.ai/PROJECT_STATUS.md`:
   - Change "Last Updated" date
   - Update completion percentage if changed
   - Move TODO items to DONE if completed
   - Add new TODOs if discovered
   - Add questions for next session

2. `.ai/AGENT_CONTEXT.md` (only if):
   - New architectural pattern introduced
   - New common mistake discovered
   - Design decision changed

3. Git commit with clear message:
   ```
   feat: Add flag action UI wiring

   - Added flag button to SegmentsList component
   - Registered command in extension.ts
   - Updated PROJECT_STATUS.md
   ```

---

## File Organization

```
voight/
‚îú‚îÄ‚îÄ .ai/                          # üëà AI agent context (hidden from git)
‚îÇ   ‚îú‚îÄ‚îÄ PROJECT_STATUS.md         # Current status, TODOs, metrics
‚îÇ   ‚îú‚îÄ‚îÄ AGENT_CONTEXT.md          # Patterns, decisions, guidelines
‚îÇ   ‚îî‚îÄ‚îÄ .claude.md                # This file
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ detection/                # Paste detection + complexity
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # Highlighting + UI components
‚îÇ   ‚îú‚îÄ‚îÄ analysis/                 # üöß TODO: Dependency tracer
‚îÇ   ‚îî‚îÄ‚îÄ ai/                       # üöß TODO: AI explainer
‚îú‚îÄ‚îÄ webview-ui/                   # Webview components
‚îî‚îÄ‚îÄ package.json                  # Commands, settings, metadata
```

---

## Vocabulary (Use Consistently)

- **Segment**: User-facing term for detected code block
- **Block**: Internal data structure
- **Action**: User operation (Dismiss, Flag, Trace, Explain, Note)
- **State**: Block status (DETECTED, REVIEWED, FLAGGED, ACCEPTED, DISMISSED)
- **Complexity**: 1-10 score (combines CCN + size)
- **CCN**: Cyclomatic Complexity Number (raw count)
- **Foreign Code**: Code not typed by user (pasted/AI-generated)
- **Trace**: Show dependencies (not "call graph")
- **Explain**: AI analysis (not "generate explanation")

---

## Priority Guidance

**Immediate** (High ROI, Low Effort):
1. Flag action UI (2-3 hours)
2. Note input UI (3-4 hours)

**Next** (Core V1 Features):
3. Trace dependency analyzer (3-5 days)
4. Explain with BYOK AI (2-3 days)

**Later** (Polish):
5. Keyboard shortcuts
6. Accessibility
7. Performance optimization

---

## Questions? Blocked?

1. **Check docs first**:
   - `.ai/PROJECT_STATUS.md` for status
   - `.ai/AGENT_CONTEXT.md` for patterns
   - `ARCHITECTURE.md` for architecture

2. **Search codebase**:
   - Find similar existing code
   - Check how it's done there

3. **Check git history**:
   - `git log --oneline -20`
   - See how similar features were added

4. **Debug**:
   - Enable debug mode
   - Check Output panel
   - Use webview DevTools

5. **Still stuck?**:
   - Document the blocker in PROJECT_STATUS.md
   - Add to "Questions for Next Session"

---

## Remember

- **Read PROJECT_STATUS.md first** - Always know current state
- **Follow patterns** - Consistency matters
- **Trust the user** - Assume competence
- **Keep it simple** - No unnecessary complexity
- **Update docs** - Future agents need context
- **Test manually** - Should take <60 seconds

---

**This extension helps developers stay in the loop. Your code should do the same: inform, don't enforce.**
